---
- name: Windows Server Hardening Playbook
  hosts: windows
  gather_facts: yes
  become: yes

  tasks:

  - name: Ensure Windows Updates are installed
    win_updates:
      category_names:
        - SecurityUpdates
        - CriticalUpdates
      reboot: yes

  - name: Disable unused services
    win_service:
      name: "{{ item }}"
      start_mode: disabled
      state: stopped
    loop:
      - RemoteRegistry
      - Spooler
      - SNMP
      - Fax
      - XboxGipSvc

  - name: Rename Administrator account
    win_user:
      name: Administrator
      rename: SysAdmin

  - name: Disable Guest account
    win_user:
      name: Guest
      state: disabled

  - name: Enable Windows Defender Firewall
    win_firewall_rule:
      name: "Enable Firewall"
      enable: yes
      state: present
      direction: in
      action: allow

  - name: Disable SMBv1
    win_optional_feature:
      name: SMB1Protocol
      state: absent

  - name: Enable Network Level Authentication for RDP
    win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp
      name: UserAuthentication
      data: 1
      type: dword

  - name: Enable Windows Defender real-time protection
    win_defender:
      state: enabled
      realtime_protection_enabled: yes
      scan_type: quick

  - name: Configure audit policies
    win_audit_policy_system:
      subcategory: "{{ item.name }}"
      audit_type: "{{ item.type }}"
    loop:
      - { name: 'Logon', type: 'Success,Failure' }
      - { name: 'Policy Change', type: 'Success,Failure' }
      - { name: 'Privilege Use', type: 'Failure' }

  - name: Disable weak SSL/TLS protocols
    win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.0\Server
      name: Enabled
      data: 0
      type: dword

  - name: Encrypt system drive with BitLocker
    win_shell: |
      Enable-BitLocker -MountPoint "C:" -EncryptionMethod XtsAes256 -UsedSpaceOnly -SkipHardwareTest

  - name: Reboot server if required
    win_reboot:
      msg: "System reboot required to complete hardening"
      pre_reboot_delay: 30

Usage:
ansible-playbook -i inventory win_hardening.yml
